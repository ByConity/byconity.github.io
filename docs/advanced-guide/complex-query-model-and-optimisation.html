<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-advanced-guide/complex-query-model-and-optimisation">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Complex Query Models and Execution Tuning | ByConity</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://byconity.github.io/img/byconity-social-card.png"><meta data-rh="true" name="twitter:image" content="https://byconity.github.io/img/byconity-social-card.png"><meta data-rh="true" property="og:url" content="https://byconity.github.io/docs/advanced-guide/complex-query-model-and-optimisation"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Complex Query Models and Execution Tuning | ByConity"><meta data-rh="true" name="description" content="Complex query execution model"><meta data-rh="true" property="og:description" content="Complex query execution model"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://byconity.github.io/docs/advanced-guide/complex-query-model-and-optimisation"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/advanced-guide/complex-query-model-and-optimisation" hreflang="en"><link data-rh="true" rel="alternate" href="https://byconity.github.io/zh-cn/docs/advanced-guide/complex-query-model-and-optimisation" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/advanced-guide/complex-query-model-and-optimisation" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ByConity RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ByConity Atom Feed"><link rel="stylesheet" href="/assets/css/styles.ca3e33a6.css">
<link rel="preload" href="/assets/js/runtime~main.940fd602.js" as="script">
<link rel="preload" href="/assets/js/main.277df070.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_dYNx" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_HwYA"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_rLhL themedImage--light_CjtC"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_rLhL themedImage--dark_quyK"></div><b class="navbar__title text--truncate">ByConity</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/introduction/main-principle-concepts">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/users">Users</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">English</a><ul class="dropdown__menu"><li><a href="/docs/advanced-guide/complex-query-model-and-optimisation" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-cn/docs/advanced-guide/complex-query-model-and-optimisation" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文（中国）</a></li></ul></div><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"><span>GitHub</span></a><div class="searchBox_ldyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_MxCR docsWrapper_h_X8"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_Kzpt" type="button"></button><div class="docPage_GWs5"><aside class="theme-doc-sidebar-container docSidebarContainer_ldoy"><div class="sidebarViewport_TwFD"><div class="sidebar_H_01 sidebarWithHideableNavbar_Ezn7"><a tabindex="-1" class="sidebarLogo_NiAm" href="/"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_rLhL themedImage--light_CjtC"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_rLhL themedImage--dark_quyK"><b>ByConity</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_J18w"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/introduction/main-principle-concepts">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/sql-syntax/ansi-compatibility">SQL Syntax</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/basic-guide/background-task-management">Basic Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/advanced-guide/background-task-configuration">Advanced Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advanced-guide/background-task-configuration">Background Tasks Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advanced-guide/bucket-table-best-practice">Bucket table best practice manual</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advanced-guide/column-based-storage">Column Storage Design Principles</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/advanced-guide/complex-query-model-and-optimisation">Complex Query Models and Execution Tuning</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advanced-guide/import-optimisation">Import Optimisation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advanced-guide/managing-concurrency">事物和并发控制</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advanced-guide/query-optimiser">Query Optimizer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/advanced-guide/resource-manager">resource manager</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/community/community-code-of-conduct">Community</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/deployment/deploy-k8s">Deployment</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_baW4"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Njrt"><div class="docItemContainer_ZzVP"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_HWXL" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_IT7R"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Advanced Guides</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Complex Query Models and Execution Tuning</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_GIgr theme-doc-toc-mobile tocMobile_JEhh"><button type="button" class="clean-btn tocCollapsibleButton_Q9up">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Complex query model and execution tuning</h1><h2 class="anchor anchorWithHideOnScrollNavbar_kuKB" id="complex-query-execution-model">Complex query execution model<a href="#complex-query-execution-model" class="hash-link" aria-label="Direct link to Complex query execution model" title="Direct link to Complex query execution model">​</a></h2><p><img loading="lazy" src="/assets/images/boxcnUIHT3GY66QcCm0sXdVUrxc-9adadd60bf95fe79b67512fe58018575.png" width="1070" height="462" class="img_Ne1E"></p><p><strong>Complex query execution model diagram</strong></p><p>Analytical queries can be classified into simple and complex queries. Simple queries typically involve retrieving and aggregating data from a single table, as well as joining large and small tables, with fast query response times. Complex queries, on the other hand, involve large tables, multiple table associations, and complex logic processing, often with slow query response times and high resource consumption. ByConity is optimized for complex queries.</p><p>For simple queries, a two-stage execution model is used, with the partial stage executed on the computing node and the final stage executed on the service node. However, when executing complex queries involving multiple aggregations or joins, the flexibility of the two-stage execution model is limited, making query optimization challenging. To better support distributed queries and facilitate the execution of the execution plan generated by the optimizer, we have introduced complex queries that support multiple rounds of distributed execution mode.</p><p>The execution flow of a complex query is as follows:</p><ul><li>Query SQL String is parsed into AST by parser</li><li>Rewrite and optimize AST to generate an execution plan</li><li>When the optimizer is enabled, an execution plan is generated by the optimizer.</li><li>Divide the execution plan into multiple PlanSegments</li><li>PlanSegment is an execution segment in the distributed execution process, which contains</li><li>The AST fragment required for execution, or a logical execution plan fragment composed of PlanNode</li><li>Node information for PlanSegment execution</li><li>The upstream and downstream information of PlanSegment, which includes the upstream input flow and the input flow required by the downstream</li><li>The engine&#x27;s scheduler will form these PlanSegments into a DAG, and then distribute them to all nodes in the cluster according to topological sorting</li><li>After each node receives the PlanSegment, it starts to drive the execution of the PlanSegment</li><li>The PlanSegment containing the data source starts to read the data, and distributes the data to the downstream nodes according to certain shuffle rules</li><li>The PlanSegment containing the exchange input waits for upstream data, and if it needs to continue to shuffle, it will continue to send the data to each node</li><li>After multiple rounds of stages are completed, the results will be returned to the server</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_kuKB" id="how-to-enable-it">How to enable it<a href="#how-to-enable-it" class="hash-link" aria-label="Direct link to How to enable it" title="Direct link to How to enable it">​</a></h2><p>Enabling the optimizer will automatically follow the complex query execution model. It can be enabled by configuring enable_optimizer=1, or dialect_type=&#x27;ANSI&#x27;.</p><ul><li>Make sure statistics exist</li></ul><p>Without statistics, the resulting query plan is suboptimal. <code>show stats [&lt;db_name&gt;.]&lt;table_name&gt;</code></p><ul><li>Analyze the time spent on each Step of the plan</li></ul><p>The time-consuming of each Step can be displayed by <code>explain analyze sql</code></p><ul><li>Exchange parameter tuning</li></ul><p>Exchange operators are responsible for data transfer between PlanSegments.</p><p><code>exchange_source_pipeline_threads</code> affects the total number of threads executed by the pipeline, especially for non-source pipelines (referring to pipelines that directly read data from storage). Currently, the default setting is the number of CPU cores. There is currently no ideal recommended value. You can consider /2 or \ *2 Observation results. If the query memory usage is large, it can be adjusted down.</p><p><code>exchange_timeout_ms</code> Exchange timeout time (ms), the default is 100s, if there is an Exchange-related timeout error, you can increase it appropriately</p><p><code>exchange_unordered_output_parallel_size</code> affects the concurrency of exchange output data, the default is 8, and generally does not need to be adjusted. If the adjustment of exchange_source_pipeline_threads is relatively large, you can appropriately increase exchange_unordered_output_parallel_size to increase the upstream output capacity.</p><p><code>exchange_enable_block_compress</code> Whether to enable exchange compression, it is enabled by default, if the CPU bottleneck is more obvious than the network, you can try to turn it off</p><h2 class="anchor anchorWithHideOnScrollNavbar_kuKB" id="reference-documentation">Reference Documentation<a href="#reference-documentation" class="hash-link" aria-label="Direct link to Reference Documentation" title="Direct link to Reference Documentation">​</a></h2></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags__Zuh padding--none margin-left--sm"><li class="tag_G1J1"><a class="tag_lVyf tagRegular_MP1R" href="/docs/tags/docs">Docs</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ByConity/byconity.github.io/tree/main/docs/advanced-guide/complex-query-model-and-optimisation.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_rssB" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_ZTIL"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/advanced-guide/column-based-storage"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Column Storage Design Principles</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/advanced-guide/import-optimisation"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Import Optimisation</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_a4zv thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#complex-query-execution-model" class="table-of-contents__link toc-highlight">Complex query execution model</a></li><li><a href="#how-to-enable-it" class="table-of-contents__link toc-highlight">How to enable it</a></li><li><a href="#reference-documentation" class="table-of-contents__link toc-highlight">Reference Documentation</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row"><div class="col col--3"><img src="/img/footer-logo.svg" alt="ByConity" class="themedImage_rLhL themedImage--light_CjtC footer__logo"><img src="/img/footer-logo.svg" alt="ByConity" class="themedImage_rLhL themedImage--dark_quyK footer__logo"></div><div class="col"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/main-principle-concepts">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/community">Community</a></li><li class="footer__item"><a class="footer__link-item" href="/users">Users</a></li><li class="footer__item"><a href="https://space.bilibili.com/2065226922?spm_id_from=333.1007.0.0" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bilibili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_TSiV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ByteDance.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.940fd602.js"></script>
<script src="/assets/js/main.277df070.js"></script>
</body>
</html>