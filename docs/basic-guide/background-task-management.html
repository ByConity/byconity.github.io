<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-basic-guide/background-task-management">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Background Tasks Management | ByConity</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://byconity.github.io/img/byconity-social-card.png"><meta data-rh="true" name="twitter:image" content="https://byconity.github.io/img/byconity-social-card.png"><meta data-rh="true" property="og:url" content="https://byconity.github.io/docs/basic-guide/background-task-management"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Background Tasks Management | ByConity"><meta data-rh="true" name="description" content="Document Type: Tutorial"><meta data-rh="true" property="og:description" content="Document Type: Tutorial"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://byconity.github.io/docs/basic-guide/background-task-management"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/basic-guide/background-task-management" hreflang="en"><link data-rh="true" rel="alternate" href="https://byconity.github.io/zh-cn/docs/basic-guide/background-task-management" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/basic-guide/background-task-management" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Y8UJSN6KEB-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ByConity RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ByConity Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BYY7CCPJZ6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-BYY7CCPJZ6",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ByConity" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.25c3bd5d.css">
<link rel="preload" href="/assets/js/runtime~main.98eb43e6.js" as="script">
<link rel="preload" href="/assets/js/main.be28c132.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_Rzz1" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_hfek"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--light_hbln"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--dark_qgR1"></div><b class="navbar__title text--truncate">ByConity</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/introduction/main-principle-concepts">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/users">Users</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">English</a><ul class="dropdown__menu"><li><a href="/docs/basic-guide/background-task-management" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-cn/docs/basic-guide/background-task-management" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文（中国）</a></li></ul></div><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"><span>GitHub</span></a><div class="searchBox_mmj0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_NWrx docsWrapper_oNqO"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_LsNq" type="button"></button><div class="docPage_fHU4"><aside class="theme-doc-sidebar-container docSidebarContainer_jEGB"><div class="sidebarViewport_Gc0S"><div class="sidebar_uCr1 sidebarWithHideableNavbar_P_fD"><a tabindex="-1" class="sidebarLogo_XXeG" href="/"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--light_hbln"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--dark_qgR1"><b>ByConity</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_s63m"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/introduction/main-principle-concepts">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/quick-start/basic-database-operations">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/sql-syntax/ansi-compatibility">SQL Syntax</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/basic-guide/background-task-management">Basic Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/basic-guide/background-task-management">Background Tasks Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/client-connection">Client Connection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/cluster-configuration">Cluster Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/data-export">Export Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/data-import">Import Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/data-type">Data Type</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/data-visualisation">Data Visualisation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/database-table-design">Database Table Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/hive-external-table">Hive External Table</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/monitoring">Monitor Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/virtual-warehouse-configuration">Virtual Warehouse Configuration</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/advanced-guide/0.2.0_s3_upgrade_checklist">Advanced Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/community/become-maintainer">Community</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/deployment/deployment-requirements">Deployment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/benchmarks/2023-09-13-byconity-tpcds-benchmark-olap/2023-09-13-byconity-vs-other-olap-engines-tpc-ds-benchmarks">benchmarks</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_b8RI"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_QMJw"><div class="docItemContainer_EkDS"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_dvLu" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_ObZR"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Basic Guides</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Background Tasks Management</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_Iw4v theme-doc-toc-mobile tocMobile_L4iJ"><button type="button" class="clean-btn tocCollapsibleButton_Omde">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Background Tasks Management</h1><p>Document Type: Tutorial</p><p>Document structure: tutorial purpose, pre-preparation, step-by-step explanation of principles &amp; examples, and related document recommendations;</p><p>Summary:</p><ol><li>What are the common background tasks and their functions</li><li>How to manually start and terminate background tasks</li><li>How to deal with common errors</li></ol><p>ByConity reuses the classic design of <a href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/" target="_blank" rel="noopener noreferrer">Community ClickHouse MergeTree</a>, which means that data is written at Part granularity Store and ensure the order of data inside each Part, and process multiple Parts in parallel when executing queries. The background Merge thread continuously merges multiple Parts into larger Parts, which not only reduces the number of Parts, but also achieves a wider range of data ordering, which is a key operation for continuously improving query performance.</p><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="common-background-tasks">Common background tasks<a href="#common-background-tasks" class="hash-link" aria-label="Direct link to Common background tasks" title="Direct link to Common background tasks">​</a></h2><p><strong>MergeMutate background task: </strong>Because ByConity is a storage and computing separation architecture, Part no longer belongs to a fixed node, and each Part can be processed by any computing node, so each computing node does not run exclusively like the community ClickHouse Merge and Mutate threads. Instead, we create a Merge and Mutate background task for each table on the Server component, which manages and schedules all Merge and Mutate tasks for the corresponding table in a unified manner.</p><p><strong>GC<!-- -->*<!-- -->*</strong>Background task:<!-- -->*<!-- -->*<!-- -->Merge multiple Parts into a new Part, which means that the original Part will no longer be used, and deleting these eliminated Parts in time will help save storage. To this end, we run a dedicated GC (Garbage Collection) background task for each table, which is responsible for the discovery and deletion of expired parts of the table.</p><p><strong>CONSUMER background task: </strong>Based on ByConity&#x27;s new cloud-native architecture, a new design and implementation has been made on real-time import consumption (aka CnchKafka):</p><ul><li>Based on each Kafka consumption table, a CONSUMER background task (ConsumeManager) is resident in the server segment;</li><li>The CONSUMER background task is responsible for reading Kafka meta information, assigning partitions to each consumer task, and then distributing task tasks to worker nodes for execution;</li><li>At the same time, the CONSUMER task needs to maintain a heartbeat with the task to ensure that each consumer task is in a normal working state.</li></ul><p>By design, Merge and GC are two separate processes. After a Merge task is completed, we will not delete the old part immediately, but correspondingly generate an elimination mark for each old part, waiting for subsequent GC tasks to be processed uniformly. Such a design can:</p><ul><li>Maintain the consistency of the Part life cycle, and there will be no inconsistent behavior of &quot;using a deleted Part&quot; during query execution.</li><li>Avoid bulky metadata and storage access operations. Deleting the old part immediately when the merge is completed means a large number of fragmented IO operations, which makes the operation inefficient and easily affects the normal execution of other processes.</li><li>Simpler implementation. There is no need to think too much about the consistency between the Merge task state and the Part state.</li></ul><p><img loading="lazy" src="/assets/images/boxcnyNZuYWKFyUqFHQ8wAYsIOy-976376ed9c27fcd526c6d1052a8f4763.png" width="852" height="408" class="img_astN"></p><p>Figure X-1</p><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="mergemutate-background-task">MergeMutate background task<a href="#mergemutate-background-task" class="hash-link" aria-label="Direct link to MergeMutate background task" title="Direct link to MergeMutate background task">​</a></h2><p>MergeMutate background tasks are mainly responsible for: Select the appropriate Part to generate the corresponding <strong>Merge Task (Merge Task)</strong>, select the appropriate part to generate <strong>Mutate Task (Mutate Task)</strong>, and send the generated Task to Appropriate Worker execution and final submission and update of Part status.</p><p>Merge and Mutate are actually two different tasks.</p><p>The Merge task is to select some smaller parts to synthesize a larger part, so as to reduce the number of files accessed during query, thereby reducing the time required for query.</p><p>The Mutate task is to perform changes on some columns in the part (Modify column, Drop column, etc.). The Mutate task is generated by the Alter query. For an Alter query, we can split it into two parts, one is to modify the schema operation of the table, and the other is to generate a Mutate Task to be executed by the background task if the data needs to be changed. Data modification operations.</p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="merge-task-part-selection">Merge task Part selection<a href="#merge-task-part-selection" class="hash-link" aria-label="Direct link to Merge task Part selection" title="Direct link to Merge task Part selection">​</a></h3><p>From the very beginning of design, ByConity requires that a system be able to handle different scenarios and businesses of different scales at the same time: the coexistence of real-time tables and offline tables, the coexistence of large-scale tables and small tables, the coexistence of wide tables and narrow tables, etc., complex fields and simple fields coexist. Such a complex application scenario means that the Parts of each table have no uniform rules to follow in terms of size, timeliness, and orderliness. To this end, we design and implement an adaptive Part selection strategy. The general process is as follows:</p><ul><li>Maintain the latest data write time, total number of Parts and total size for each partition (Partition).</li><li>First select a batch of partitions from all partitions, and users can specify their preferred strategy for each table: sort by write time; sort by the number of parts or training in rotation.</li><li>For each selected partition, scan all its Parts, calculate the benefits of merging each other according to the number of rows, size, and writing time of the Parts, and finally select multiple groups of Parts in the order of benefits.</li><li>Finally, for each selected partition, if no high-yielding Merge task is finally selected from the partition, the partition will not be selected for a subsequent period of time to achieve adaptive adjustment.</li></ul><p><img loading="lazy" src="/assets/images/boxcnnvwD2ZKklNKkrVatqtnjUb-878ff829c9123ed16041a10d2485beb4.png" width="852" height="1022" class="img_astN"></p><p>Figure X-2</p><p>As shown in the figure, in the Partition selection stage, we selected Partition 1 (the largest number of Parts) and Partition 2 (the latest data writing). Then calculate the combined income between Parts from these two Partitions, and finally select three groups of Parts: p11~p12, p13~p16, and p23~p24.</p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="task-scheduling-management">Task scheduling management<a href="#task-scheduling-management" class="hash-link" aria-label="Direct link to Task scheduling management" title="Direct link to Task scheduling management">​</a></h3><p>For each group of Parts selected above, we will estimate its task overhead, such as required disk size, occupied memory size, and other information. Then select the most suitable Worker for this task through <u>Resource Manager</u> (Note: link to RM), and send it out for execution.</p><p>When Worker executes a task, it obtains the required Part through the interface provided by the storage layer. The merging process of Part on Worker is similar to the principle of Community ClickHouse.</p><p>After the Merge task is executed, the Worker returns a successful execution flag to the Server. After that, the server can submit the newly generated Part and mark the merged source Part, waiting for subsequent GC background tasks to process.</p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="heartbeat-mechanism">Heartbeat Mechanism<a href="#heartbeat-mechanism" class="hash-link" aria-label="Direct link to Heartbeat Mechanism" title="Direct link to Heartbeat Mechanism">​</a></h3><p>Since the execution time of the MergeMutate task may be relatively long, we need to use the heartbeat mechanism to detect whether the task on the Worker has failed or whether the Worker has been down, and remove the failed task on the Server in time. At the same time, the Worker side will also judge whether the Server is down by the time of the last synchronization heartbeat when executing the task, so as to end the task in advance to avoid wasting resources.</p><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="gc-background-tasks">GC background tasks<a href="#gc-background-tasks" class="hash-link" aria-label="Direct link to GC background tasks" title="Direct link to GC background tasks">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="part-visibility-judgment">Part visibility judgment<a href="#part-visibility-judgment" class="hash-link" aria-label="Direct link to Part visibility judgment" title="Direct link to Part visibility judgment">​</a></h3><p>Different from the part visibility judgment in the community, ByConity has made some adjustments to the part visibility judgment in order to better implement the MVCC (Multi-Version Concurrency Control) feature.</p><p>First, briefly introduce the naming structure of writing part. Part naming is as follows:</p><p><img loading="lazy" src="/assets/images/boxcn35mmn27RkI7PnEdYgJML3g-825992d45aca226f63edf2118c630cad.png" width="852" height="320" class="img_astN"></p><ol><li>Community version Part visibility judgment, taking the Merge task as an example</li></ol><p><img loading="lazy" src="/assets/images/boxcn9MQ9pAUXo2fFk9xURxVGrh-461ff747290e0260ce50370bf5a75133.png" width="852" height="762" class="img_astN"></p><ol><li>ByConityPart visibility judgment (TODO)</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="gc-task">GC Task<a href="#gc-task" class="hash-link" aria-label="Direct link to GC Task" title="Direct link to GC Task">​</a></h3><p>After understanding the role and process of <u>Merge</u> and Part visibility rules, you can better understand the working mechanism of GC.</p><p>As shown in Figure X-1, the GC background task of each table runs independently, and it is mainly responsible for discovering and deleting the eliminated parts generated by the Merge task.</p><p>When the server marks an obsolete part, it does not change any state of the part, but generates a new corresponding marked part, and the marked part does not occupy the actual storage space. Doing so can guarantee the absolute immutability of all Parts throughout the lifetime. <!-- -->*<!-- -->*</p><p>Based on Figure X-2, after the Merge is completed, it will become the state shown in Figure X-3 below:</p><p><img loading="lazy" src="/assets/images/boxcnuwPQMcD1U9cypYG0DdP1th-9e2b61a2cd466d2e01badc1699af6f4e.png" width="852" height="480" class="img_astN"></p><p>When the GC background task is running, it is similar to the Merge background task,</p><ul><li>A batch of Partitions will be selected in order of the total number of Parts and total size.</li><li>Then scan all Parts in the Partition, and delete the Part covered by the mark (that is, the blue part).</li><li>Then scan all Parts in the Partition again, and delete the marked Part (that is, the red part).</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="consumer-tasks">CONSUMER tasks<a href="#consumer-tasks" class="hash-link" aria-label="Direct link to CONSUMER tasks" title="Direct link to CONSUMER tasks">​</a></h2><p>ByConity inherits the basic design of community Kafka consumption, and designs and implements a new consumption table engine CnchKafka based on the new cloud-native architecture. The basic consumption principle is consistent with the community, and the entire consumption link is realized through a &lt;CnchKafka consumption table, Materialized View materialized view table, storage table&gt; triplet, where:</p><ul><li>CnchKafka consumption table: responsible for subscribing to Kafka topics and consuming messages; parsing the obtained messages and writing them as Blocks;</li><li>Materialized View materialized view table: build a data path from the consumption table to the storage table, write the block consumed by CnchKafka into the storage table, and provide a simple filtering function;</li><li>Storage table: Support various MergeTree storage tables of Cnch.</li></ul><p>The basic data path is as follow:</p><p><img loading="lazy" src="/assets/images/boxcnzUYNuizBq5CUpsp0ZZAzoz-8f3b6d8f7092df4cbff90bfd5115de2c.png" width="852" height="492" class="img_astN"></p><p>The components in the figure are ByConity components related to CnchKafka. For specific component descriptions, please refer to the architecture document.</p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="kafkaconsumemanager">KafkaConsumeManager<a href="#kafkaconsumemanager" class="hash-link" aria-label="Direct link to KafkaConsumeManager" title="Direct link to KafkaConsumeManager">​</a></h3><p>Each CnchKafka consumption table will start a Manager (that is, CONSUMER type background task) at the server layer to be responsible for scheduling and managing all consumer tasks. The Manager itself is a resident thread on the server side, and its service is guaranteed to be stable through the high availability of the server and DaemonManager.</p><p>The main implementation and functions of KafkaConsumeManager include:</p><ul><li>Distribute the topic partition evenly to each consumer according to the configured number of consumers;</li><li>Interact with the Catalog to obtain the offset consumed by the partition;</li><li>Schedule the consumer to the configured Virtual Warehouse node for execution:</li><li>Node selection supports multiple policy configurations to ensure load balancing;</li><li>Regularly detect each consumer task to ensure the stability of task execution.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="kafkaconsumer">KafkaConsumer<a href="#kafkaconsumer" class="hash-link" aria-label="Direct link to KafkaConsumer" title="Direct link to KafkaConsumer">​</a></h3><p>Each KafkaConsumer is implemented as a resident thread and executed on the Virtual Warehouse node. It is responsible for consuming data from the specified topic partition, converting it into parts and writing it to VFS, and submitting meta information back to the server side for writing to the Catalog. main feature:</p><ul><li>Inherit the batch writing mode of the community (each consumption cycle defaults to 8 seconds);</li><li>Each consumption process guarantees atomicity through Transaction:</li><li>Create transactions by interacting with Server RPC;</li><li>The transaction commit will submit the written part meta-information and the latest consumed offset at the same time.</li></ul><p>Refer to the figure below for the execution process of a single consumption:</p><p><img loading="lazy" src="/assets/images/boxcnSgFjCeQGVkbtqB3b1013gf-d42dcff9e6716fe35060170db3994a06.png" width="852" height="580" class="img_astN"></p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="exactly-once">Exactly-Once<a href="#exactly-once" class="hash-link" aria-label="Direct link to Exactly-Once" title="Direct link to Exactly-Once">​</a></h3><p>Compared with the community implementation, the CnchKafka implementation has enhanced consumption semantics, that is, from the community&#x27;s At-Least-Once semantics to Exactly-Once semantics. This is mainly due to the guarantee of the new architecture Transaction.</p><p>Since each round of consumption will go through transaction management, and the corresponding offset will be submitted at the same time as the data metadata information is submitted each time. Since the transaction guarantees the atomicity of the commit, the data metadata and offset are either submitted successfully at the same time, or both fail to be submitted.</p><p>This ensures that the data and offset are always consistent, and each restart of consumption will continue to consume from the last submitted offset position, thus realizing Exactly-Once.</p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="automatic-fault-tolerance-implementation">Automatic fault tolerance implementation<a href="#automatic-fault-tolerance-implementation" class="hash-link" aria-label="Direct link to Automatic fault tolerance implementation" title="Direct link to Automatic fault tolerance implementation">​</a></h3><p>CnchKafka&#x27;s overall fault-tolerant strategy adopts <strong>fast failure</strong> approach, namely:</p><ul><li>KafkaConsumeManager regularly detects consumer tasks, if the detection fails, a new consumer is immediately pulled;</li><li>In each execution of KafkaConsumer, the two interactions with Server RPC (creating transaction and submitting transaction) will verify the validity of itself to the Manager. If the verification fails (for example, the Manager has pulled a new consumer, etc.), it will Take the initiative to kill yourself.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="modify-consumption-parameters">Modify consumption parameters<a href="#modify-consumption-parameters" class="hash-link" aria-label="Direct link to Modify consumption parameters" title="Direct link to Modify consumption parameters">​</a></h3><p>Supports quick modification of Setting parameters through the ALTER command, which is mainly used to adjust the number of consumers and improve consumption capabilities.</p><p>Command:</p><div class="codeBlockContainer_Dtwu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sgmo"><pre tabindex="0" class="prism-code language-text codeBlock_zjcW thin-scrollbar"><code class="codeBlockLines_u4eB"><span class="token-line" style="color:#393A34"><span class="token plain">ALTER TABLE &lt;cnch_kafka_name&gt; MODIFY SETTING &lt;name1&gt; = &lt;value1&gt;, &lt;name2&gt; = &lt;value2&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_uzaf"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MWsZ" aria-hidden="true"><svg class="copyButtonIcon_utg0" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YlgY" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Execution of this command will automatically restart the consumption task.</p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="manually-start-and-stop-consumption">Manually start and stop consumption<a href="#manually-start-and-stop-consumption" class="hash-link" aria-label="Direct link to Manually start and stop consumption" title="Direct link to Manually start and stop consumption">​</a></h3><p>In some scenarios, users may need to manually stop consumption, and then manually resume; we provide the corresponding SYSTEM command implementation:</p><div class="codeBlockContainer_Dtwu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sgmo"><pre tabindex="0" class="prism-code language-text codeBlock_zjcW thin-scrollbar"><code class="codeBlockLines_u4eB"><span class="token-line" style="color:#393A34"><span class="token plain">SYSTEM START/STOP/RESTART CONSUME &lt;cnch_kafka_name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_uzaf"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MWsZ" aria-hidden="true"><svg class="copyButtonIcon_utg0" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YlgY" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: The START/STOP command will persist the corresponding state to the Catalog, so after executing the STOP command, if you do not execute START, even if the service restarts, the consumption task will not resume.</p><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="control-background-tasks">Control background tasks<a href="#control-background-tasks" class="hash-link" aria-label="Direct link to Control background tasks" title="Direct link to Control background tasks">​</a></h2><p>The system command is provided to control the opening and closing of background tasks. Unlike the community, the control through the system command is a persistent operation, and background tasks that have been stopped will not be rescheduled after the server restarts.</p><p>Provide the system table system.bg_threads to view the status of background tasks, including thread status, scheduling times, scheduling exception information, etc.</p><div class="codeBlockContainer_Dtwu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sgmo"><pre tabindex="0" class="prism-code language-text codeBlock_zjcW thin-scrollbar"><code class="codeBlockLines_u4eB"><span class="token-line" style="color:#393A34"><span class="token plain">SYSTEM STOP/START/RESTART CONSUME db.table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SYSTEM STOP/START MERGES/GC db.table;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SELECT * FROM system.bg_threads WHERE database = &#x27;db&#x27; AND table = &#x27;table&#x27;;</span><br></span></code></pre><div class="buttonGroup_uzaf"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MWsZ" aria-hidden="true"><svg class="copyButtonIcon_utg0" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YlgY" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="common-error">common error<a href="#common-error" class="hash-link" aria-label="Direct link to common error" title="Direct link to common error">​</a></h2><ol><li>Connection Refused from DaemonManager</li></ol><div class="codeBlockContainer_Dtwu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sgmo"><pre tabindex="0" class="prism-code language-text codeBlock_zjcW thin-scrollbar"><code class="codeBlockLines_u4eB"><span class="token-line" style="color:#393A34"><span class="token plain">Code: 5038. DB::Exception: Received from 127.0.0.1:9000. DB::Exception: 112:[E111]Fail to connect Socket{id=1155 addr=127.0.0.1:10090} (0x0x7f2f9674f6c0): Connection refused [R1][E112]Not connected to 127.0.0.1:10090 yet, server_id=1155 [R2][E112]Not connected to 127.0.0.1:10090 yet, server_id=1155 [R3][E112]Not connected to 127.0.0.1:10090 yet, server_id=1155.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_uzaf"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MWsZ" aria-hidden="true"><svg class="copyButtonIcon_utg0" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YlgY" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The specific error information is as above, where 10090 is the rpc port of DaemonManager, which means that the connection of DaemonManager component failed, and the status of DaemonManager needs to be checked.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_HAaO padding--none margin-left--sm"><li class="tag_Ut5_"><a class="tag_sQub tagRegular_dfhI" href="/docs/tags/docs">Docs</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ByConity/byconity.github.io/tree/main/docs/basic-guide/background-task-management.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_O9Og" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_DEFe"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/sql-syntax/urls"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">URLs</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/basic-guide/client-connection"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Client Connection</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Q7NC thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#common-background-tasks" class="table-of-contents__link toc-highlight">Common background tasks</a></li><li><a href="#mergemutate-background-task" class="table-of-contents__link toc-highlight">MergeMutate background task</a><ul><li><a href="#merge-task-part-selection" class="table-of-contents__link toc-highlight">Merge task Part selection</a></li><li><a href="#task-scheduling-management" class="table-of-contents__link toc-highlight">Task scheduling management</a></li><li><a href="#heartbeat-mechanism" class="table-of-contents__link toc-highlight">Heartbeat Mechanism</a></li></ul></li><li><a href="#gc-background-tasks" class="table-of-contents__link toc-highlight">GC background tasks</a><ul><li><a href="#part-visibility-judgment" class="table-of-contents__link toc-highlight">Part visibility judgment</a></li><li><a href="#gc-task" class="table-of-contents__link toc-highlight">GC Task</a></li></ul></li><li><a href="#consumer-tasks" class="table-of-contents__link toc-highlight">CONSUMER tasks</a><ul><li><a href="#kafkaconsumemanager" class="table-of-contents__link toc-highlight">KafkaConsumeManager</a></li><li><a href="#kafkaconsumer" class="table-of-contents__link toc-highlight">KafkaConsumer</a></li><li><a href="#exactly-once" class="table-of-contents__link toc-highlight">Exactly-Once</a></li><li><a href="#automatic-fault-tolerance-implementation" class="table-of-contents__link toc-highlight">Automatic fault tolerance implementation</a></li><li><a href="#modify-consumption-parameters" class="table-of-contents__link toc-highlight">Modify consumption parameters</a></li><li><a href="#manually-start-and-stop-consumption" class="table-of-contents__link toc-highlight">Manually start and stop consumption</a></li></ul></li><li><a href="#control-background-tasks" class="table-of-contents__link toc-highlight">Control background tasks</a></li><li><a href="#common-error" class="table-of-contents__link toc-highlight">common error</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row"><div class="col col--3"><img src="/img/footer-logo.svg" alt="ByConity" class="themedImage_DeRy themedImage--light_hbln footer__logo"><img src="/img/footer-logo.svg" alt="ByConity" class="themedImage_DeRy themedImage--dark_qgR1 footer__logo"></div><div class="col"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/main-principle-concepts">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/community">Community</a></li><li class="footer__item"><a class="footer__link-item" href="/users">Users</a></li><li class="footer__item"><a href="https://space.bilibili.com/2065226922?spm_id_from=333.1007.0.0" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bilibili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_LBPb"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_LBPb"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ByteDance.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.98eb43e6.js"></script>
<script src="/assets/js/main.be28c132.js"></script>
</body>
</html>