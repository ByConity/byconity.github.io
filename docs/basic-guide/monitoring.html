<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-basic-guide/monitoring">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Monitor Cluster | ByConity</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://byconity.github.io/img/byconity-social-card.png"><meta data-rh="true" name="twitter:image" content="https://byconity.github.io/img/byconity-social-card.png"><meta data-rh="true" property="og:url" content="https://byconity.github.io/docs/basic-guide/monitoring"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Monitor Cluster | ByConity"><meta data-rh="true" name="description" content="Prometheus Monitoring Indicators："><meta data-rh="true" property="og:description" content="Prometheus Monitoring Indicators："><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://byconity.github.io/docs/basic-guide/monitoring"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/basic-guide/monitoring" hreflang="en"><link data-rh="true" rel="alternate" href="https://byconity.github.io/zh-cn/docs/basic-guide/monitoring" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/basic-guide/monitoring" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Y8UJSN6KEB-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ByConity RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ByConity Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BYY7CCPJZ6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-BYY7CCPJZ6",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ByConity" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.25c3bd5d.css">
<link rel="preload" href="/assets/js/runtime~main.3ecab9c8.js" as="script">
<link rel="preload" href="/assets/js/main.424036cf.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_Rzz1" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_hfek"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--light_hbln"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--dark_qgR1"></div><b class="navbar__title text--truncate">ByConity</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/introduction/main-principle-concepts">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community">Community</a><a class="navbar__item navbar__link" href="/users">Users</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">English</a><ul class="dropdown__menu"><li><a href="/docs/basic-guide/monitoring" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-cn/docs/basic-guide/monitoring" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文（中国）</a></li></ul></div><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"><span>GitHub</span></a><div class="searchBox_mmj0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_NWrx docsWrapper_oNqO"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_LsNq" type="button"></button><div class="docPage_fHU4"><aside class="theme-doc-sidebar-container docSidebarContainer_jEGB"><div class="sidebarViewport_Gc0S"><div class="sidebar_uCr1 sidebarWithHideableNavbar_P_fD"><a tabindex="-1" class="sidebarLogo_XXeG" href="/"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--light_hbln"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--dark_qgR1"><b>ByConity</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_s63m"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/introduction/main-principle-concepts">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/quick-start/basic-database-operations">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/sql-syntax/ansi-compatibility">SQL Syntax</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/basic-guide/background-task-management">Basic Guides</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/background-task-management">Background Tasks Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/client-connection">Client Connection</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/cluster-configuration">Cluster Configuration</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/data-export">Export Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/data-import">Import Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/data-type">Data Type</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/data-visualisation">Data Visualisation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/database-table-design">Database Table Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/hive-external-table">Hive External Table</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/basic-guide/monitoring">Monitor Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/basic-guide/virtual-warehouse-configuration">Virtual Warehouse Configuration</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/advanced-guide/0.2.0_s3_upgrade_checklist">Advanced Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/community/become-maintainer">Community</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/deployment/deployment-requirements">Deployment</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_b8RI"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_QMJw"><div class="docItemContainer_EkDS"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_dvLu" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_ObZR"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Basic Guides</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Monitor Cluster</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_Iw4v theme-doc-toc-mobile tocMobile_L4iJ"><button type="button" class="clean-btn tocCollapsibleButton_Omde">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Monitor Cluster</h1><h1>Common Monitoring Indicators</h1><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="prometheus-monitoring-indicators">Prometheus Monitoring Indicators：<a href="#prometheus-monitoring-indicators" class="hash-link" aria-label="Direct link to Prometheus Monitoring Indicators：" title="Direct link to Prometheus Monitoring Indicators：">​</a></h2><p>The engine spits out monitoring items under the path of the HTTP interface <code>/metrics</code>, the default port is 8123, and you can directly access the output of the corresponding port.</p><p>The corresponding metric output can be viewed through kubectl</p><div class="codeBlockContainer_Dtwu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sgmo"><pre tabindex="0" class="prism-code language-text codeBlock_zjcW thin-scrollbar"><code class="codeBlockLines_u4eB"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward -n cnch cnch-default-server-0 8123:8123</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># use port-forward function to proxy port</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_uzaf"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MWsZ" aria-hidden="true"><svg class="copyButtonIcon_utg0" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YlgY" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>After that, you can open localhost:8123/metrics with a browser, and you can view the indicator display as shown in the figure below. Each line corresponds to a specific index item, which conforms to the index format agreed by Prometheus.
<img loading="lazy" src="/assets/images/boxcnMqU9e8xvq46v7IH9ORtLCf-69b89b581b04f353e3f545df9f414d45.png" width="2208" height="496" class="img_astN"></p><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="victoriametric-metric-aggregation">VictoriaMetric Metric Aggregation：<a href="#victoriametric-metric-aggregation" class="hash-link" aria-label="Direct link to VictoriaMetric Metric Aggregation：" title="Direct link to VictoriaMetric Metric Aggregation：">​</a></h2><p>Choose VictoriaMetric for the storage of indicators, which is convenient for horizontal expansion of storage and provides richer functions.</p><p>An important feature among these is the VMRule, which aggregates raw metrics. Because some of the original Prometheus indicators spit out by each component can be directly used to build monitoring alarms, the other part is more complicated and it is not easy to directly build monitoring dashboards and alarms, so it is aggregated through VWRule. The following is the rule configuration file cnch-metrics.yaml:</p><div class="codeBlockContainer_Dtwu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sgmo"><pre tabindex="0" class="prism-code language-text codeBlock_zjcW thin-scrollbar"><code class="codeBlockLines_u4eB"><span class="token-line" style="color:#393A34"><span class="token plain"># Source: victoria-rules/templates/cnch-metrics.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: operator.victoriametrics.com/v1beta1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: VMRule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: release-name-victoria-rule-cnch-metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  namespace: cnch-operator-default-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app: victoria-rules</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    chart: victoria-rules-0.1.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    release: &quot;release-name&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    heritage: &quot;Helm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  groups:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: CnchMetricsLatency</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Histogram at VW level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_vw:pct95</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            histogram_quantile(0.95,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum by (cluster, namespace, vw, le)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rate(cnch_histogram_metrics_query_latency_bucket[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Histogram at Cluster level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_cluster:pct95</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            histogram_quantile(0.95,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum by (cluster, namespace, le)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rate(cnch_histogram_metrics_query_latency_bucket[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trends Metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trend Latency VW level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_vw:pct95:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: avg_over_time(cnch:latency:queries_vw:pct95[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trend Latency Cluster level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_cluster:pct95:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: avg_over_time(cnch:latency:queries_cluster:pct95[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Histogram at VW level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_vw:pct99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            histogram_quantile(0.99,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum by (cluster, namespace, vw, le)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rate(cnch_histogram_metrics_query_latency_bucket[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Histogram at Cluster level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_cluster:pct99</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            histogram_quantile(0.99,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum by (cluster, namespace, le)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                rate(cnch_histogram_metrics_query_latency_bucket[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trends Metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trend Latency VW level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_vw:pct99:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: avg_over_time(cnch:latency:queries_vw:pct99[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trend Latency Cluster level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_cluster:pct99:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: avg_over_time(cnch:latency:queries_cluster:pct99[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trend Slow Q VW level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_vw:slow_ratio:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: avg_over_time(cnch:latency:queries_vw:slow_ratio[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trend Slow Q Cluster level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_cluster:slow_ratio:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: avg_over_time(cnch:latency:queries_cluster:slow_ratio[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Slow Q VW level  (Percentage of query &gt; 10s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_vw:slow_ratio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum by (cluster, namespace, vw)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              rate(cnch_histogram_metrics_query_latency_count[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - on (namespace, pod, cluster, vw, instance) rate(cnch_histogram_metrics_query_latency_bucket{le=&quot;10000&quot;}[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum by (cluster, namespace, vw)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              rate(cnch_histogram_metrics_query_latency_count[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Slow Q Cluster level (Percentage of query &gt; 10s)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_cluster:slow_ratio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum by (cluster, namespace)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              rate(cnch_histogram_metrics_query_latency_count[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - on (namespace, pod, cluster, vw, instance) rate(cnch_histogram_metrics_query_latency_bucket{le=&quot;10000&quot;}[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum by (cluster, namespace)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              rate(cnch_histogram_metrics_query_latency_count[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Slow Q Cluster level (count queries &gt; 10s) used by OP portal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_cluster:slow_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum by (cluster, namespace)(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              increase(cnch_histogram_metrics_query_latency_count[1h])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - on (namespace, pod, cluster, vw, instance) increase(cnch_histogram_metrics_query_latency_bucket{le=&quot;10000&quot;}[1h])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Todo check if this metric became server only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:latency:queries_timeout:rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum by (cluster, namespace, pod, workload) (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              rate(cnch_profile_events_timed_out_query_total[5m])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: CnchMetricsQPS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trend WG workload level</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # - record: cnch:profile_events:query:total_rate5m:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        #   expr: avg_over_time(sum by (cluster, namespace, workload, type) (cnch:profile_events:query:total_rate5m)[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trend VW QPS VW level. server POV only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:total_rate5m:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: avg_over_time(sum by (cluster, namespace, vw, query_type) (cnch:profile_events:labelled_query_vw:total_rate5m)[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # VW QPS cluster level Todo use sum(avg_1d{vw != &quot;&quot;}) if no similar reenable this Trend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_cluster:total_rate5m:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            avg_over_time(sum by (cluster, namespace, query_type) (cnch:profile_events:labelled_query_vw:total_rate5m)[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Trend VW Error Ratio VW level (can&#x27;t sum burnrate % so we pre-recorded a burnrate summed at vw level)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw_sum:error_burnrate5m:avg_1d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            avg_over_time(cnch:profile_events:labelled_query_vw_sum:error_burnrate5m[1d])</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Number of workers in a WG that use more than 80% memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:workers:high_mem_rss:80pct_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              count(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                (sum(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    container_memory_rss{container!=&quot;&quot;, image!=&quot;&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  * on(namespace,pod)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;cnch.*worker.*|vw.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ) by (pod, namespace, workload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                / sum(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    kube_pod_container_resource_limits{resource=&quot;memory&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  * on(namespace,pod)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    group_left(workload, workload_type) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;cnch.*worker.*|vw.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ) by (pod, namespace, workload)) &gt; 0.80</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ) by (namespace, workload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              count(namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;cnch.*worker.*|vw.*&quot;}) by (namespace, workload)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Byteyard Usage Profiler metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:vw:metrics:running_queries:time_milliseconds_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: sum by (vw_id, cluster) (increase(cnch_internal_metrics_running_queries_time_milliseconds_total[30s]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:vw:metrics:queued_queries:time_milliseconds_total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: sum by (vw_id, cluster) (increase(cnch_internal_metrics_queued_queries_time_milliseconds_total[30s]))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      # Query Error Ratio over multiple intervals aka burn rate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record server POV, for vw only, the unlimited are only used for few dashboard and 1 alert rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Worker POV is used in workers dashboard only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:total_rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[5m])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record workers POV, used by Byteyard autosuspend (server pov might not have direct insert) and workers graph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw_workers:total_rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[5m])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload!~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TEMP until byteyard support cnch:profile_events:labelled_query_vw_workers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TODO remove this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_event:queries_vw_only:total_rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cnch:profile_events:labelled_query_vw_workers:total_rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:total_rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_tso_request_total[5m])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Err/s default to 0 if a request total exist (e.g. only success request) so it&#x27;s included in availability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_queries_failed_total{failure_type!=&quot;QueriesFailedFromUser&quot;, resource_type=&quot;vw&quot;}[5m])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace, resource_type, query_type, vw, wg) (cnch:profile_events:labelled_query_vw:total_rate5m)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_tso_error_total[5m])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace) (cnch:tso:requests:total_rate5m)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Use WG level precision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_burnrate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:error_rate5m) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:total_rate5m) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_burnrate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:error_rate5m) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:total_rate5m) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record server POV, for vw only, the unlimited are only used for few dashboard and 1 alert rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Worker POV is used in workers dashboard only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:total_rate30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[30m])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record workers POV, used by Byteyard autosuspend (server pov might not have direct insert) and workers graph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw_workers:total_rate30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[30m])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload!~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TEMP until byteyard support cnch:profile_events:labelled_query_vw_workers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TODO remove this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_event:queries_vw_only:total_rate30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cnch:profile_events:labelled_query_vw_workers:total_rate30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:total_rate30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_tso_request_total[30m])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Err/s default to 0 if a request total exist (e.g. only success request) so it&#x27;s included in availability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_rate30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_queries_failed_total{failure_type!=&quot;QueriesFailedFromUser&quot;, resource_type=&quot;vw&quot;}[30m])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace, resource_type, query_type, vw, wg) (cnch:profile_events:labelled_query_vw:total_rate30m)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_rate30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_tso_error_total[30m])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace) (cnch:tso:requests:total_rate30m)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Use WG level precision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_burnrate30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:error_rate30m) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:total_rate30m) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_burnrate30m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:error_rate30m) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:total_rate30m) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record server POV, for vw only, the unlimited are only used for few dashboard and 1 alert rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Worker POV is used in workers dashboard only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:total_rate1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[1h])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record workers POV, used by Byteyard autosuspend (server pov might not have direct insert) and workers graph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw_workers:total_rate1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[1h])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload!~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TEMP until byteyard support cnch:profile_events:labelled_query_vw_workers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TODO remove this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_event:queries_vw_only:total_rate1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cnch:profile_events:labelled_query_vw_workers:total_rate1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:total_rate1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_tso_request_total[1h])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Err/s default to 0 if a request total exist (e.g. only success request) so it&#x27;s included in availability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_rate1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_queries_failed_total{failure_type!=&quot;QueriesFailedFromUser&quot;, resource_type=&quot;vw&quot;}[1h])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace, resource_type, query_type, vw, wg) (cnch:profile_events:labelled_query_vw:total_rate1h)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_rate1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_tso_error_total[1h])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace) (cnch:tso:requests:total_rate1h)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Use WG level precision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_burnrate1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:error_rate1h) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:total_rate1h) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_burnrate1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:error_rate1h) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:total_rate1h) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record server POV, for vw only, the unlimited are only used for few dashboard and 1 alert rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Worker POV is used in workers dashboard only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:total_rate6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[6h])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record workers POV, used by Byteyard autosuspend (server pov might not have direct insert) and workers graph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw_workers:total_rate6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[6h])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload!~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TEMP until byteyard support cnch:profile_events:labelled_query_vw_workers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TODO remove this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_event:queries_vw_only:total_rate6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cnch:profile_events:labelled_query_vw_workers:total_rate6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:total_rate6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_tso_request_total[6h])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Err/s default to 0 if a request total exist (e.g. only success request) so it&#x27;s included in availability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_rate6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_queries_failed_total{failure_type!=&quot;QueriesFailedFromUser&quot;, resource_type=&quot;vw&quot;}[6h])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace, resource_type, query_type, vw, wg) (cnch:profile_events:labelled_query_vw:total_rate6h)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_rate6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_tso_error_total[6h])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace) (cnch:tso:requests:total_rate6h)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Use WG level precision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_burnrate6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:error_rate6h) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:total_rate6h) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_burnrate6h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:error_rate6h) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:total_rate6h) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record server POV, for vw only, the unlimited are only used for few dashboard and 1 alert rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Worker POV is used in workers dashboard only</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:total_rate3d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[3d])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Record workers POV, used by Byteyard autosuspend (server pov might not have direct insert) and workers graph</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw_workers:total_rate3d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;vw&quot;}[3d])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload!~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TEMP until byteyard support cnch:profile_events:labelled_query_vw_workers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # TODO remove this</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_event:queries_vw_only:total_rate3d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            cnch:profile_events:labelled_query_vw_workers:total_rate3d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:total_rate3d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_tso_request_total[3d])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Err/s default to 0 if a request total exist (e.g. only success request) so it&#x27;s included in availability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_rate3d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_queries_failed_total{failure_type!=&quot;QueriesFailedFromUser&quot;, resource_type=&quot;vw&quot;}[3d])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace, resource_type, query_type, vw, wg) (cnch:profile_events:labelled_query_vw:total_rate3d)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel{workload=~&quot;.*server.*&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_rate3d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ((</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              sum(rate(cnch_profile_events_tso_error_total[3d])) by (pod, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            or</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0 * group by (pod, cluster, namespace) (cnch:tso:requests:total_rate3d)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Use WG level precision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw:error_burnrate3d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:error_rate3d) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:total_rate3d) by (workload, cluster, namespace, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:tso:requests:error_burnrate3d</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:error_rate3d) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:tso:requests:total_rate3d) by (workload, cluster, namespace)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Use VW level precision only 5m timeframe used for dashboard only (trend avg_1d)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_vw_sum:error_burnrate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:error_rate5m) by (cluster, namespace, vw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(cnch:profile_events:labelled_query_vw:total_rate5m) by (cluster, namespace, vw)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        # Only used for few dashboard and 1 error alert rule, no need burn rate worker+ server POV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_unlimited:total_rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_labelled_query_total{resource_type=&quot;unlimited&quot;}[5m])) by (pod, cluster, namespace, query_type)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:profile_events:labelled_query_unlimited:error_rate5m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum(rate(cnch_profile_events_queries_failed_total{failure_type!=&quot;QueriesFailedFromUser&quot;, resource_type=&quot;unlimited&quot;}[5m])) by (pod, cluster, namespace, query_type, vw, wg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            * on (pod, namespace) group_left(workload) namespace_workload_pod:kube_pod_owner:relabel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    - name: CnchMetricsAvailability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      rules:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:wg:availability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            slo: error_rate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # 1 = available, 0 = unavailable</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # min() check if any of the burn rate is firing (1, 1, 0) -&gt; 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # For any burn rate, both time window must be triggered (Multiwindow) so we use max() (1, 0) -&gt; 1 avail</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # TODO maybe change this with a ALERTS{alertstate=&quot;firing&quot;,severity=&quot;critical&quot;, alertname=~&quot;.*BudgetBurn&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          # As we can&#x27;t have the &#x27;for 15m&#x27; here see: https://github.com/metalmatze/slo-libsonnet/issues/52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            min by (cluster, namespace, vw, wg) (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              max by (cluster, namespace, vw, wg) (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cnch:profile_events:labelled_query_vw:error_burnrate5m{vw=~&quot;.*&quot;} &lt;= bool (14.40 * (1 - 0.99)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cnch:profile_events:labelled_query_vw:error_burnrate1h{vw=~&quot;.*&quot;} &lt;= bool (14.40 * (1 - 0.99))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              max by (cluster, namespace, vw, wg) (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cnch:profile_events:labelled_query_vw:error_burnrate30m{vw=~&quot;.*&quot;} &lt;= bool (6.00 * (1 - 0.99)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cnch:profile_events:labelled_query_vw:error_burnrate6h{vw=~&quot;.*&quot;} &lt;= bool (6.00 * (1 - 0.99))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              max by (cluster, namespace, vw, wg) (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cnch:profile_events:labelled_query_vw:error_burnrate6h{vw=~&quot;.*&quot;} &lt;= bool (1.00 * (1 - 0.99)),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                cnch:profile_events:labelled_query_vw:error_burnrate3d{vw=~&quot;.*&quot;} &lt;= bool (1.00 * (1 - 0.99))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - record: cnch:cluster:availability</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          expr: |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            1 - (sum by (cluster, namespace) (cnch:profile_events:labelled_query_vw:error_rate5m)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            sum by (cluster, namespace) (cnch:profile_events:labelled_query_vw:total_rate5m))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_uzaf"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MWsZ" aria-hidden="true"><svg class="copyButtonIcon_utg0" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YlgY" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Use kubectl to execute the configuration to take effect:</p><div class="codeBlockContainer_Dtwu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sgmo"><pre tabindex="0" class="prism-code language-text codeBlock_zjcW thin-scrollbar"><code class="codeBlockLines_u4eB"><span class="token-line" style="color:#393A34"><span class="token plain">kubctl apply -f cnch-metrics.yaml # Configure the corresponding rule</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup_uzaf"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MWsZ" aria-hidden="true"><svg class="copyButtonIcon_utg0" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YlgY" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Monitoring service node (Server)</p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="important-indicators">Important indicators<a href="#important-indicators" class="hash-link" aria-label="Direct link to Important indicators" title="Direct link to Important indicators">​</a></h3><p>The more important indicators are excerpted below for explanation</p><table><thead><tr><th>Metric name (the ones in double quotes are VM-aggregated)）</th><th>Description</th></tr></thead><tbody><tr><td>cnch:latency:queries_cluster:pct95 cnch:latency:queries_cluster:pct99</td><td>Query latency pct99 and pct55</td></tr><tr><td>cnch:latency:queries_cluster:slow_ratio</td><td>The proportion of slow queries longer than 10s</td></tr><tr><td>cnch:profile_events:labelled_query_vw:total_rate5m</td><td>Total QPS of all VW</td></tr><tr><td>cnch:profile_events:labelled_query_vw:error_rate5m</td><td>Failed QPS for all VWs</td></tr><tr><td>cnch_current_metrics_query</td><td>The value of the label name query_type is insert, which is the written query</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="configure-grafana-kanban-for-the-service-node-server">Configure Grafana Kanban for the service node (Server)<a href="#configure-grafana-kanban-for-the-service-node-server" class="hash-link" aria-label="Direct link to Configure Grafana Kanban for the service node (Server)" title="Direct link to Configure Grafana Kanban for the service node (Server)">​</a></h3><p>Kanban content see screenshot</p><p><img loading="lazy" src="/assets/images/boxcnvwueXWFISCRgsRJ66J2vKb-8988c2af21fed0034abda7d7d9f4154c.jpeg" width="3337" height="9813" class="img_astN"></p><p>Important indicators:</p><table><thead><tr><th>Kanban Name</th><th>Expression</th><th>Description</th></tr></thead><tbody><tr><td>Queries Ducations</td><td><code>cnch:latency:queries_cluster:pct95{namespace=&quot;$namespace&quot;, cluster=&quot;$cluster&quot;}和cnch:latency:queries_cluster:pct99{namespace=&quot;$namespace&quot;, cluster=&quot;$cluster&quot;}</code></td><td>Query latency P99 和 P95</td></tr><tr><td>Slow Queries &gt; 10s</td><td><code>cnch:latency:queries_cluster:slow_ratio{namespace=&quot;$namespace&quot;, cluster=&quot;$cluster&quot;}</code></td><td>The proportion of slow queries longer than 10s</td></tr><tr><td>Queries Per Second</td><td><code>sum(cnch:profile_events:labelled_query_vw:total_rate5m{namespace=&quot;$namespace&quot;, cluster=&quot;$cluster&quot;, workload=~&quot;$workload&quot;})</code></td><td>Total QPS for all VWs</td></tr><tr><td>VW Queries Success</td><td><code>1 - (sum by (pod) (cnch:profile_events:labelled_query_vw:error_rate5m{cluster=&quot;$cluster&quot;, namespace=&quot;$namespace&quot;, workload=~&quot;$workload&quot;, pod=~&quot;$pod&quot;}) sum by (pod) (cnch:profile_events:labelled_query_vw:total_rate5m{cluster=&quot;$cluster&quot;, namespace=&quot;$namespace&quot;, workload=~&quot;$workload&quot;, pod=~&quot;$pod&quot;}))</code></td><td>After subtracting and dividing error_rate5m and total_rate5m, the success rate is obtained</td></tr></tbody></table><p>The complete Grafana configuration file of the Server is as follows, which can be imported in the Grafana UI：<a target="_blank" href="/assets/files/cnch-server-9c3a5e54b12f5d1f9fd04500abba5385.json">cnch-server.json</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="monitor-tso">Monitor TSO<a href="#monitor-tso" class="hash-link" aria-label="Direct link to Monitor TSO" title="Direct link to Monitor TSO">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="important-indicators-1">important indicators<a href="#important-indicators-1" class="hash-link" aria-label="Direct link to important indicators" title="Direct link to important indicators">​</a></h3><p>The following excerpts are some important indicators for TSO to illustrate:</p><table><thead><tr><th>Indicators</th><th>Description</th></tr></thead><tbody><tr><td>cnch:tso:requests:error_rate5m</td><td>Failed QPS for TSO components</td></tr><tr><td>cnch:tso:requests:total_rate5m</td><td>Total QPS for TSO components</td></tr></tbody></table><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="configure-grafana-kanban-for-tso">Configure Grafana Kanban for TSO<a href="#configure-grafana-kanban-for-tso" class="hash-link" aria-label="Direct link to Configure Grafana Kanban for TSO" title="Direct link to Configure Grafana Kanban for TSO">​</a></h3><p>The screenshot of the board is as follows:</p><p><img loading="lazy" src="/assets/images/boxcn3CLoRUlpCEDJnEy8f6dxPe-9a6fde5cfab3aa39288f253a549a1c39.jpeg" width="3355" height="5626" class="img_astN"></p><p>Important indicators:</p><table><thead><tr><th>Kanban Name</th><th>Expression</th><th>Description</th></tr></thead><tbody><tr><td>TSO Server Requests Per Sec</td><td><code>cnch:tso:requests:total_rate5m{namespace=&quot;$namespace&quot;, cluster=&quot;$cluster&quot;, workload=~&quot;.*server.*&quot;}</code></td><td>QPS of Server component for TSO query</td></tr><tr><td>TSO Worker Requests Per Sec</td><td><code>cnch:tso:requests:total_rate5m{namespace=&quot;$namespace&quot;, cluster=&quot;$cluster&quot;, workload!~&quot;.*(server\|**kafka**).*&quot;}</code></td><td>Remove the server and kafka, and only look at the request QPS of each worker for TSO</td></tr><tr><td>TSO Servers Requests Server Rate</td><td><code>cnch:tso:requests:error_rate5m{namespace=&quot;$namespace&quot;, cluster=&quot;$cluster&quot;, workload=~&quot;.*server.*&quot;} cnch:tso:requests:total_rate5m{namespace=&quot;$namespace&quot;, cluster=&quot;$cluster&quot;, workload=~&quot;.*server.*&quot;}</code></td><td>Divide error_rate and total_rate to filter the failure rate of TSO query</td></tr></tbody></table><p>The complete configuration file of TSO is as follows:<a target="_blank" href="/assets/files/cnch-cluster-defa551fd417f26c9d0c8e0c0e9c8613.json">cnch-tso.json</a></p><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="other-information-that-can-be-monitored">Other information that can be monitored<a href="#other-information-that-can-be-monitored" class="hash-link" aria-label="Direct link to Other information that can be monitored" title="Direct link to Other information that can be monitored">​</a></h2><p>Other commonly used monitoring board configurations are listed here, no more screenshots</p><p>Cluster Overview: Overview of the entire cluster <a target="_blank" href="/assets/files/cnch-cluster-defa551fd417f26c9d0c8e0c0e9c8613.json">cnch-cluster.json</a></p><p>VW: detials of each Virtual Warehouse <a target="_blank" href="/assets/files/cnch-vw-9aaaa58db804949d69e5f0f302c1546e.json">cnch-vw.json</a></p><p>DaemonManager: Components that manages background tasks such as Merge <a target="_blank" href="/assets/files/cnch-daemonmanager-50a069af4bc2e5eb5bd58652959bb1f8.json">cnch-daemonmanager.json</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_HAaO padding--none margin-left--sm"><li class="tag_Ut5_"><a class="tag_sQub tagRegular_dfhI" href="/docs/tags/docs">Docs</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ByConity/byconity.github.io/tree/main/docs/basic-guide/monitoring.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_O9Og" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_DEFe"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/basic-guide/hive-external-table"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Hive External Table</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/basic-guide/virtual-warehouse-configuration"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Virtual Warehouse Configuration</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Q7NC thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#prometheus-monitoring-indicators" class="table-of-contents__link toc-highlight">Prometheus Monitoring Indicators：</a></li><li><a href="#victoriametric-metric-aggregation" class="table-of-contents__link toc-highlight">VictoriaMetric Metric Aggregation：</a><ul><li><a href="#important-indicators" class="table-of-contents__link toc-highlight">Important indicators</a></li><li><a href="#configure-grafana-kanban-for-the-service-node-server" class="table-of-contents__link toc-highlight">Configure Grafana Kanban for the service node (Server)</a></li></ul></li><li><a href="#monitor-tso" class="table-of-contents__link toc-highlight">Monitor TSO</a><ul><li><a href="#important-indicators-1" class="table-of-contents__link toc-highlight">important indicators</a></li><li><a href="#configure-grafana-kanban-for-tso" class="table-of-contents__link toc-highlight">Configure Grafana Kanban for TSO</a></li></ul></li><li><a href="#other-information-that-can-be-monitored" class="table-of-contents__link toc-highlight">Other information that can be monitored</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row"><div class="col col--3"><img src="/img/footer-logo.svg" alt="ByConity" class="themedImage_DeRy themedImage--light_hbln footer__logo"><img src="/img/footer-logo.svg" alt="ByConity" class="themedImage_DeRy themedImage--dark_qgR1 footer__logo"></div><div class="col"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/main-principle-concepts">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/community">Community</a></li><li class="footer__item"><a class="footer__link-item" href="/users">Users</a></li><li class="footer__item"><a href="https://space.bilibili.com/2065226922?spm_id_from=333.1007.0.0" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bilibili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_LBPb"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_LBPb"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ByteDance.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3ecab9c8.js"></script>
<script src="/assets/js/main.424036cf.js"></script>
</body>
</html>