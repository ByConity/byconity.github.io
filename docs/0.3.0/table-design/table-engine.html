<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-0.3.0 plugin-docs plugin-id-default docs-doc-id-table-design/table-engine">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Table Engines | ByConity</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://byconity.github.io/img/byconity-social-card.png"><meta data-rh="true" name="twitter:image" content="https://byconity.github.io/img/byconity-social-card.png"><meta data-rh="true" property="og:url" content="https://byconity.github.io/docs/0.3.0/table-design/table-engine"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="0.3.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-0.3.0"><meta data-rh="true" name="docsearch:version" content="0.3.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-0.3.0"><meta data-rh="true" property="og:title" content="Table Engines | ByConity"><meta data-rh="true" name="description" content="The table engine determines the way data is organized and stored, the method and type of indexing, which queries are supported, and how they are supported, as well as some other specific features and configurations. In ByConity, the most commonly used table engines are CnchMergeTree, CnchKafka, and CnchMaterializedMySql. This article focuses on explaining the principles of these three table engines."><meta data-rh="true" property="og:description" content="The table engine determines the way data is organized and stored, the method and type of indexing, which queries are supported, and how they are supported, as well as some other specific features and configurations. In ByConity, the most commonly used table engines are CnchMergeTree, CnchKafka, and CnchMaterializedMySql. This article focuses on explaining the principles of these three table engines."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://byconity.github.io/docs/0.3.0/table-design/table-engine"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/0.3.0/table-design/table-engine" hreflang="en"><link data-rh="true" rel="alternate" href="https://byconity.github.io/zh-cn/docs/0.3.0/table-design/table-engine" hreflang="zh-cn"><link data-rh="true" rel="alternate" href="https://byconity.github.io/docs/0.3.0/table-design/table-engine" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://Y8UJSN6KEB-dsn.algolia.net" crossorigin="anonymous"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="ByConity RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="ByConity Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-BYY7CCPJZ6"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-BYY7CCPJZ6",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ByConity" href="/opensearch.xml"><link rel="stylesheet" href="/assets/css/styles.25c3bd5d.css">
<link rel="preload" href="/assets/js/runtime~main.41346e7c.js" as="script">
<link rel="preload" href="/assets/js/main.7c81538f.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_Rzz1" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbarHideable_hfek"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--light_hbln"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--dark_qgR1"></div><b class="navbar__title text--truncate">ByConity</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/0.3.0/introduction/what-is-byconity">Docs</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/community/become-maintainer">Community</a><a class="navbar__item navbar__link" href="/users">Users</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/0.3.0/introduction/what-is-byconity">0.3.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/table-design/table-engine">0.4.x</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/0.3.0/table-design/table-engine">0.3.0</a></li><li><a class="dropdown__link" href="/docs/0.2.0/introduction/main-principle-concepts">0.2.0</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">English</a><ul class="dropdown__menu"><li><a href="/docs/0.3.0/table-design/table-engine" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="en">English</a></li><li><a href="/zh-cn/docs/0.3.0/table-design/table-engine" target="_self" rel="noopener noreferrer" class="dropdown__link" lang="zh-cn">中文（中国）</a></li></ul></div><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link"><span>GitHub</span></a><div class="searchBox_mmj0"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_NWrx docsWrapper_oNqO"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_LsNq" type="button"></button><div class="docPage_fHU4"><aside class="theme-doc-sidebar-container docSidebarContainer_jEGB"><div class="sidebarViewport_Gc0S"><div class="sidebar_uCr1 sidebarWithHideableNavbar_P_fD"><a tabindex="-1" class="sidebarLogo_XXeG" href="/"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--light_hbln"><img src="/img/logo.png" alt="ByConity Logo" class="themedImage_DeRy themedImage--dark_qgR1"><b>ByConity</b></a><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_s63m"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/introduction/what-is-byconity">Introduction</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/quick-start/docker-deploy">Quick Start</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/deployment/deployment-requirements">Deployment</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/data-export/data-export-method">Data Export</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/data-import/data-introduction">Data Import</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/0.3.0/table-design/data-model">Table Design</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.3.0/table-design/data-model">Data Model</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/0.3.0/table-design/table-engine">Table Engines</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.3.0/table-design/indexes">Indexes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.3.0/table-design/data-compression">Data Compression</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/0.3.0/table-design/unique-key">Unique Key</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/data-lakes/hive-external-table">Data Lake</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/query-optimization/query-optimizer">Query Optimization</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/integration/client-connection">Integration</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/sql-syntax/data-types">SQL Syntax</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/admin-guides/resource-manager">Admin Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/benchmarks/tpc-ds">Benchmarks</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/developer-guides/how-to-build-byconity">Developer Guides</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/faq/all-in-one">FAQ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/0.3.0/release-note/0.3.0">Release Note</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_b8RI"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_QMJw"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is documentation for <!-- -->ByConity<!-- --> <b>0.3.0</b>, which is no longer actively maintained.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/table-design/table-engine">latest version</a></b> (<!-- -->0.4.x<!-- -->).</div></div><div class="docItemContainer_EkDS"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_dvLu" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_ObZR"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Table Design</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Table Engines</span><meta itemprop="position" content="2"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 0.3.0</span><div class="tocCollapsible_Iw4v theme-doc-toc-mobile tocMobile_L4iJ"><button type="button" class="clean-btn tocCollapsibleButton_Omde">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Table Engines</h1><p>The table engine determines the way data is organized and stored, the method and type of indexing, which queries are supported, and how they are supported, as well as some other specific features and configurations. In ByConity, the most commonly used table engines are CnchMergeTree, CnchKafka, and CnchMaterializedMySql. This article focuses on explaining the principles of these three table engines.</p><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="cnchmergetree-table-engine">CnchMergeTree Table Engine<a href="#cnchmergetree-table-engine" class="hash-link" aria-label="Direct link to CnchMergeTree Table Engine" title="Direct link to CnchMergeTree Table Engine">​</a></h2><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="implementation-principles">Implementation Principles<a href="#implementation-principles" class="hash-link" aria-label="Direct link to Implementation Principles" title="Direct link to Implementation Principles">​</a></h3><p>The CnchMergeTree table is the most commonly used table engine. Its core concept is similar to LSM-Tree. Data is partitioned based on the partition key (partition by) and then sorted and stored based on the sorting key (order by). Key features include:</p><ul><li>Logical Partitioning (Partition):
If a partition key is specified, data is divided into different logical datasets (logical partitions, Partition) based on the partition key. Each logical partition can contain zero or multiple data parts (DataPart). If the query conditions can be used to prune partitions, it usually speeds up the query. If no partition key is specified, all data is stored in a single logical partition.</li><li>Data Parts (Fragment):
Data within a data part is sorted based on the sorting key. Each data part also has a min/max index to accelerate partition selection.</li><li>Data Granules (Granule):
Each data part is logically divided into granules. The default granule size is 8192 rows (determined by the table&#x27;s index_granularity configuration). Granules are the smallest indivisible data sets for data queries in ByConity. The first row of each granule is marked by the primary key value of that row. ByConity creates an index file for each data part to store these markers. For each column, regardless of whether it is included in the primary key, ByConity stores similar markers. These markers allow you to directly find data in the column files. As the target of ByConity&#x27;s sparse index, granules are also the smallest units for data scanning in memory.</li><li>Background Merging:
Background tasks periodically merge DataParts within the same partition while maintaining the sorting order based on the sorting key. Background merging reduces the number of Parts for more efficient storage and improved query performance.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="table-creation-statement-and-related-configurations">Table Creation Statement and Related Configurations<a href="#table-creation-statement-and-related-configurations" class="hash-link" aria-label="Direct link to Table Creation Statement and Related Configurations" title="Direct link to Table Creation Statement and Related Configurations">​</a></h3><div class="language-sql codeBlockContainer_Dtwu theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_sgmo"><pre tabindex="0" class="prism-code language-sql codeBlock_zjcW thin-scrollbar"><code class="codeBlockLines_u4eB"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">db</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">table_name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name1 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">type1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">ALIAS expr1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">compression_codec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">TTL expr1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name2 </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">type2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token operator" style="color:#393A34">|</span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token operator" style="color:#393A34">|</span><span class="token plain">ALIAS expr2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">compression_codec</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">TTL expr2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> index_name1 expr1 </span><span class="token keyword" style="color:#00009f">TYPE</span><span class="token plain"> type1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> GRANULARITY value1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">INDEX</span><span class="token plain"> index_name2 expr2 </span><span class="token keyword" style="color:#00009f">TYPE</span><span class="token plain"> type2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> GRANULARITY value2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> CnchMergeTree</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> expr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> expr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CLUSTER </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">column</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> expression</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">INTO</span><span class="token plain"> value1 BUCKETS SPLIT_NUMBER value2 WITH_RANGE</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> expr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token keyword" style="color:#00009f">UNIQUE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> expr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SAMPLE </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> expr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">TTL expr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SETTINGS name</span><span class="token operator" style="color:#393A34">=</span><span class="token keyword" style="color:#00009f">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup_uzaf"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_MWsZ" aria-hidden="true"><svg class="copyButtonIcon_utg0" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_YlgY" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="designing-the-partition-key-partition-by">Designing the Partition Key (PARTITION BY)<a href="#designing-the-partition-key-partition-by" class="hash-link" aria-label="Direct link to Designing the Partition Key (PARTITION BY)" title="Direct link to Designing the Partition Key (PARTITION BY)">​</a></h4><p>The partition key defines partitions, which are logical datasets divided within a table based on specified rules. You can partition by any criterion, such as date. To minimize the amount of data that needs to be operated on, each partition is stored separately. During queries, ByConity tries to use the smallest subset of these partitions. The partition key is specified using the <code>PARTITION BY expr</code> clause when creating the table. The partition key can be any expression involving columns in the table. For example, to partition by month, the expression would be <code>toYYYYMM(date)</code>. Alternatively, you can use an expression tuple like <code>(toMonday(date), EventType)</code>.</p><p>It&#x27;s important to note that the range of values calculated by the partition expression in the table should not be too large (recommended to be no more than 10,000). Having too many partitions can consume significant memory and lead to increased IO and computational overhead.</p><p>Properly designing the partition key can significantly reduce the amount of data that needs to be scanned during queries. Generally, it&#x27;s recommended to design the partition key based on the most commonly used conditions in queries, while ensuring that the range of values does not exceed 10,000 (such as date).</p><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="designing-the-sorting-key-order-by">Designing the Sorting Key (ORDER BY)<a href="#designing-the-sorting-key-order-by" class="hash-link" aria-label="Direct link to Designing the Sorting Key (ORDER BY)" title="Direct link to Designing the Sorting Key (ORDER BY)">​</a></h4><p>The sorting key can be a tuple of columns or any expression. For example: <code>ORDER BY (OrderID, Date)</code>. If no sorting is required, you can use <code>ORDER BY tuple()</code>. Data within a DataPart is sorted based on the sorting key. Please note that the fields used in the order by clause cannot be modified after the table is created.</p><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="designing-the-primary-key-primary-key">Designing the Primary Key (PRIMARY KEY)<a href="#designing-the-primary-key-primary-key" class="hash-link" aria-label="Direct link to Designing the Primary Key (PRIMARY KEY)" title="Direct link to Designing the Primary Key (PRIMARY KEY)">​</a></h4><p>By default, there is no need to explicitly specify the primary key. ByConity uses the sorting key as the primary key. However, in special scenarios where the primary key and sorting key differ, the primary key must be the leftmost prefix of the sorting key. For example, if the sorting key is (OrderID, Date), the primary key must be OrderID and cannot be Date. In some special table engines, such as CnchAggregatingMergeTree and CnchSummingMergeTree, the primary key may differ from the sorting key.</p><p>ByConity creates a sparse index on the primary key, with granules as the unit (in contrast to a dense index, which creates index information for every row). If the query conditions match the leftmost prefix of the primary key index, the primary key index can quickly filter out the granules that may need to be read, which is typically much more efficient than scanning the entire DataPart.</p><p>Additionally, it&#x27;s important to note that the PRIMARY KEY does not guarantee uniqueness, so it&#x27;s possible to insert rows with duplicate primary keys. Partitioning (PARTITION BY) and the primary key (PRIMARY KEY) are two different ways to accelerate data queries. When defining them, it&#x27;s generally recommended to use different columns to cover more query scenarios. For example, avoid repeating the first column of the order by clause in the partition by clause. Here are some considerations for choosing the primary key:</p><ul><li>Whether it is a commonly used column in query conditions.</li><li>Avoid using the first column that is not the partition key.</li><li>Consider the selectivity of the column. For example, columns with few distinct values (such as gender or yes/no) are not recommended for inclusion in the primary key.</li><li>If the current primary key is (a, b) and the data range covered by (a, b) is large (spanning multiple granules), consider appending a new commonly used query column to the primary key to filter more data.</li><li>Longer primary keys can negatively impact insertion performance and memory consumption but have no impact on query performance.</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="designing-the-unique-key-unique-key">Designing the Unique Key (UNIQUE KEY)<a href="#designing-the-unique-key-unique-key" class="hash-link" aria-label="Direct link to Designing the Unique Key (UNIQUE KEY)" title="Direct link to Designing the Unique Key (UNIQUE KEY)">​</a></h4><p>The primary key (PRIMARY KEY) does not guarantee deduplication. If there is a need for unique key deduplication, a unique key index must be set when creating the table. After setting the unique key, ByConity provides an upsert update semantics, allowing efficient updating of data rows based on the unique key. Queries automatically return the latest value for each unique key.</p><p>The unique key can be a tuple of columns or any expression, such as <code>UNIQUE KEY (product_id, sipHash64(city))</code>. Unique key indexing can be controlled by configuring <code>partition_level_unique_keys</code> to determine whether it is unique at the partition level or across the entire table. Currently, it is recommended to use partition-level unique keys with no more than 10 million rows per partition. If unique keys are set at the table level, it is recommended to have no more than 10 million rows in the entire table.</p><p>When querying using a unique key, the unique key index is used to filter data and accelerate the query. Therefore, the primary key can typically be set to different columns than the unique key to cover more query conditions. However, if partial column updates are required, the unique key must be the leftmost prefix of the sorting key.</p><ul><li>Related Configurations:<ul><li><code>partition_level_unique_keys</code>: Determines whether the unique index is at the partition level. The default value is <code>true</code>. If set to <code>false</code>, the unique index applies to the entire table.</li><li><code>cloud_enable_staging_area</code>: Determines whether asynchronous write mode is enabled. The default value is <code>false</code>.</li></ul></li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="granule-configuration">Granule Configuration<a href="#granule-configuration" class="hash-link" aria-label="Direct link to Granule Configuration" title="Direct link to Granule Configuration">​</a></h4><ul><li><code>index_granularity</code> - Index granularity. The number of data rows between adjacent &#x27;marks&#x27; in the index (corresponding to Granule size). The default value is 8192.</li></ul><p>The following three configurations are pending testing and have not been verified by RD for functionality.</p><ul><li><code>index_granularity_bytes</code> - Index granularity in bytes, with a default value of 10Mb. If you want to limit the index granularity only by the number of data rows, set it to 0 (not recommended).</li><li><code>min_index_granularity_bytes</code> - The allowed minimum data granularity, with a default value of 1024b. This option is used to prevent misoperations, such as adding a table with a very low index granularity.</li><li><code>enable_mixed_granularity_parts</code> - Whether to enable controlling index granularity size through <code>index_granularity_bytes</code>. In older versions, only the <code>index_granularity</code> configuration could be used to limit the index granularity size. When querying data from tables with very large rows (tens or hundreds of megabytes), the <code>index_granularity_bytes</code> configuration can improve ByConity performance. If your table has very large rows, you can enable this configuration to improve the performance of <code>SELECT</code> queries.</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="ttl-for-columns-and-tables">TTL for Columns and Tables<a href="#ttl-for-columns-and-tables" class="hash-link" aria-label="Direct link to TTL for Columns and Tables" title="Direct link to TTL for Columns and Tables">​</a></h4><p>Specifies the duration for storing rows and defines a list of rules for moving data fragments on hard drives and volumes. This is an optional feature.</p><p>At least one column of type <code>Date</code> or <code>DateTime</code> must be present in the expression, for example:</p><p><code>TTL date + INTERVAl 1 DAY</code></p><p>For more details, please refer to <a href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree#table_engine-mergetree-ttl" target="_blank" rel="noopener noreferrer">TTL for Tables and Columns</a></p><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="best-practices">Best Practices<a href="#best-practices" class="hash-link" aria-label="Direct link to Best Practices" title="Direct link to Best Practices">​</a></h4><ul><li>Best practices for primary key indexes:</li></ul><p><a href="https://clickhouse.com/docs/zh/guides/improving-query-performance/sparse-primary-indexes/" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/zh/guides/improving-query-performance/sparse-primary-indexes/</a></p><ul><li>Best practices for secondary indexes:</li></ul><p><a href="https://clickhouse.com/docs/zh/guides/improving-query-performance/skipping-indexes" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/zh/guides/improving-query-performance/skipping-indexes</a></p><ul><li>Column type considerations:</li></ul><p>Avoid blindly using the String type.</p><p>If possible, use Int(8|16|32|64|128|256) / Date / Date32 / DateTime / DateTime64 / Float / Decimal instead of String.</p><p>A simple way to determine this is to check if the conversion to the target type is possible, such as <code>SELECT countIf(toUInt8OrNull(col) IS NULL) FROM table</code>, <code>SELECT countIf(toDateOrNull(col) IS NULL) FROM table</code>.</p><p>For String columns with relatively fixed content, consider using Enum instead, such as province names. Enum values can be added later through <code>ALTER TABLE</code>.</p><p>Use FixedString if the minimum and maximum lengths of the String do not differ by more than 8, as String requires an additional 8 bytes of offset storage compared to FixedString in memory: <code>SELECT min(length(col)), max(length(col)) FROM table</code>.</p><ul><li>Nullable selection:</li></ul><p>If you are certain that the column does not contain Null values, avoid using the Nullable type as it can negatively impact performance.</p><ul><li>LowCardinality:</li></ul><p>If a column has a low cardinality, meaning there are no more than 10,000 distinct values within a DataPart, consider using the LowCardinality type. The LowCardinality type applies dictionary encoding to the original column. For many applications, processing dictionary-encoded data can significantly increase query speed, reduce storage space, and improve IO efficiency.</p><ul><li>Reference documentation:</li></ul><p><a href="https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree#tiao-shu-suo-yin-fen-duan-hui-zong-suo-yin-shi-yan-xing-de" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/zh/engines/table-engines/mergetree-family/mergetree#tiao-shu-suo-yin-fen-duan-hui-zong-suo-yin-shi-yan-xing-de</a></p><p><a href="https://clickhouse.com/docs/en/sql-reference/statements/create/table/#column-compression-codecs" target="_blank" rel="noopener noreferrer">https://clickhouse.com/docs/en/sql-reference/statements/create/table/#column-compression-codecs</a></p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="cnchkafka-table-engine">CnchKafka Table Engine<a href="#cnchkafka-table-engine" class="hash-link" aria-label="Direct link to CnchKafka Table Engine" title="Direct link to CnchKafka Table Engine">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="functional-definition">Functional Definition<a href="#functional-definition" class="hash-link" aria-label="Direct link to Functional Definition" title="Direct link to Functional Definition">​</a></h4><p>CnchKafka is a table engine developed by ByConity based on the community&#x27;s ClickHouse Kafka table engine, specifically designed for the cloud-native architecture. It efficiently and rapidly ingests user data from Apache Kafka into ByConity. Its design and implementation not only adapt to the new cloud-native architecture but also enhance some functionalities compared to the community implementation.</p><p>Key features of CnchKafka include:</p><ul><li>Automatic fault tolerance based on cloud-native architecture advantages, reducing operational and maintenance costs.</li><li>Scalable consumption capacity: Supports adjusting the number of consumers through SYSTEM commands, with a maximum adaptation to the number of partitions corresponding to the topic.</li><li>Enhanced consumption semantics: Relies on Transaction guarantees and manages offsets through the engine to achieve Exactly-Once consumption semantics.</li><li>Consumption performance: Heavily dependent on the schema complexity of the user table, with typical values ranging from 2k to 2M rows per second and a throughput of around 15MiB/s.</li><li>Supports various data types, including but not limited to Json, ProtoBuf, CSV, etc.</li><li>Supports recording consumption logs, facilitating problem troubleshooting and providing data audit capabilities.</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="implementation-principles-1">Implementation Principles<a href="#implementation-principles-1" class="hash-link" aria-label="Direct link to Implementation Principles" title="Direct link to Implementation Principles">​</a></h4><p>CnchKafka inherits the basic design of the community, utilizing a triplet of &lt;CnchKafka consumption table, Materialized View, and storage table&gt; to achieve the entire consumption pipeline. Specifically:</p><ul><li>CnchKafka consumption table: Responsible for subscribing to Kafka topics and consuming messages; parsing the received messages into Blocks.</li><li>Materialized View: Establishes a data pathway from the consumption table to the storage table, writes Blocks consumed by CnchKafka into the storage table, and provides simple filtering capabilities.</li><li>Storage table: Supports various ByConity MergeTree storage tables.</li></ul><p>The basic data pathway is as follows:</p><p><img loading="lazy" src="/assets/images/boxcnbeMipMsWmYggoqbR4DT88c-8f3b6d8f7092df4cbff90bfd5115de2c.png" width="852" height="492" class="img_astN"></p><center>Architecture Diagram of CnchKafka Component in ByConity</center><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="component-description">Component Description<a href="#component-description" class="hash-link" aria-label="Direct link to Component Description" title="Direct link to Component Description">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="server">Server<a href="#server" class="hash-link" aria-label="Direct link to Server" title="Direct link to Server">​</a></h4><p>The application access layer serves as the entry point for all queries and import tasks. Designed as lightweight, it focuses on task scheduling, forwarding, and metadata access rather than executing specific queries or imports. Its responsibilities include:</p><ul><li>Preprocessing query requests by reading metadata from the Catalog, forwarding the raw data and query SQL to query nodes, and returning the query results to upper layers (APIs, users, etc.).</li><li>Managing import tasks by selecting import nodes for task execution.</li><li>Interacting with the Catalog to query or update metadata.</li><li>Interacting with the Resource Manager to select task execution nodes for load balancing.</li></ul><p><strong>Virtual WareHouse</strong></p><ul><li>The computing layer executes all query and import tasks as stateless services.</li><li>Supports tenant isolation for resource and data separation.</li><li>Enables read-write splitting, allowing queries and imports to create and specify different Virtual Warehouses.</li></ul><p><strong>Catalog</strong></p><ul><li>A key-value database managing metadata, including database table metadata, partition metadata, etc.</li><li>Also stores consumption offsets for CnchKafka.</li></ul><p><strong>VFS</strong></p><ul><li>The underlying storage supports multiple storage systems, including HDFS, S3, etc.</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="kafkaconsumemanager">KafkaConsumeManager<a href="#kafkaconsumemanager" class="hash-link" aria-label="Direct link to KafkaConsumeManager" title="Direct link to KafkaConsumeManager">​</a></h4><p>Each CnchKafka consumption table initiates a Manager at the Server layer responsible for scheduling and managing all consumer tasks. The Manager runs as a permanent thread on the Server, ensuring service stability through Server high availability and DaemonManager. The main functions of KafkaConsumeManager include:</p><ul><li>Evenly distributing topic partitions among consumers based on the configured number of consumers.</li><li>Interacting with the Catalog to obtain partition consumption offsets.</li><li>Scheduling consumers to execute on configured Virtual Warehouse nodes, supporting various strategies for node selection and load balancing.</li><li>Regularly checking the liveliness of each consumer task to ensure stable task execution.</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="kafkaconsumer">KafkaConsumer<a href="#kafkaconsumer" class="hash-link" aria-label="Direct link to KafkaConsumer" title="Direct link to KafkaConsumer">​</a></h4><p>Each KafkaConsumer runs as a permanent thread on a Virtual Warehouse node, consuming data from the specified topic partition, converting it into partitions written to the VFS, and submitting metadata back to the Server to be written to the Catalog. Key features include:</p><ul><li>Inherits the community&#x27;s batch write mode (default consumption cycle of 8 seconds).</li><li>Ensures atomicity through transactions during each consumption process: creates transactions through RPC interactions with the Server; transaction commits simultaneously submit written partition metadata and the latest consumption offset.</li></ul><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="exactly-once">Exactly-Once<a href="#exactly-once" class="hash-link" aria-label="Direct link to Exactly-Once" title="Direct link to Exactly-Once">​</a></h4><p>Compared to community implementations, CnchKafka enhances consumption semantics from At-Least-Once to Exactly-Once. This is primarily achieved through transaction guarantees provided by the new architecture. Each consumption round is managed transactionally, and each data metadata submission is accompanied by the corresponding offset. Since transactions ensure atomicity, either both the data metadata and offset are successfully submitted, or both fail. This ensures consistent data and offsets, allowing consumption to resume from the last submitted offset after each restart, achieving Exactly-Once semantics.</p><h4 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="automatic-fault-tolerance">Automatic Fault Tolerance<a href="#automatic-fault-tolerance" class="hash-link" aria-label="Direct link to Automatic Fault Tolerance" title="Direct link to Automatic Fault Tolerance">​</a></h4><p>CnchKafka employs a fast-fail strategy for fault tolerance:</p><ul><li>KafkaConsumeManager regularly checks the liveliness of consumer tasks. If a task fails, a new consumer is immediately started.</li><li>During each execution, KafkaConsumer interacts with the Server through RPCs (creating and committing transactions) and validates its own validity with the Manager. If validation fails (e.g., if the Manager has already started a new consumer), the KafkaConsumer proactively terminates itself.</li></ul><h2 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="designing-bucket-tables">Designing Bucket Tables<a href="#designing-bucket-tables" class="hash-link" aria-label="Direct link to Designing Bucket Tables" title="Direct link to Designing Bucket Tables">​</a></h2><p>Bucket tables are an optional table-level setting. When properly configured, the system organizes table data based on the user-provided Cluster Key (one or more columns or expressions from the table creation statement). Data with the same Cluster Key values is clustered under the same bucket number.</p><p>Clustering data using the Cluster Key can provide several benefits for large tables:</p><ul><li>Point queries on the Cluster Key can filter out most data, reducing IO and resulting in faster execution times and higher concurrent QPS.</li><li>Aggregation queries on the Cluster Key can consume less memory and execute faster, further optimized with distributed_perfect_shard.</li><li>Join operations on multiple tables using the Cluster Key can leverage co-located joins, significantly reducing shuffle data volume and execution time.</li></ul><p>Due to the complexity of Bucket table settings, they are typically suitable for two scenarios:</p><ul><li>Large tables, where the number of partitions significantly exceeds the number of workers.</li><li>Queries that can benefit from the aforementioned advantages.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="selecting-the-cluster-key">Selecting the Cluster Key<a href="#selecting-the-cluster-key" class="hash-link" aria-label="Direct link to Selecting the Cluster Key" title="Direct link to Selecting the Cluster Key">​</a></h3><p>The Cluster Key can consist of one or more columns or expressions, but it&#x27;s recommended to use no more than three fields to avoid excessive write overhead and limit the scope of beneficial queries.</p><p>Choosing the right Cluster Key is crucial for performance and requires careful consideration. General guidelines include:</p><ul><li>Columns frequently used for equality or IN filters.</li><li>Columns commonly used for aggregations.</li><li>Join keys for multiple tables.</li></ul><p>If a common scenario involves combining two columns (e.g., a = 1 and b = 2), using both as the Cluster Key can yield better results.</p><p>Another factor to consider is the number of distinct values for each column. Since data with the same Cluster Key values is grouped under the same bucket number, and all partitions under a bucket number are sent to the same worker for computation, it&#x27;s important to:</p><ul><li>Have enough distinct values to utilize all worker nodes. The number of distinct values should ideally exceed the number of workers.</li><li>If the number of distinct values is small, prefer columns with the highest distinct value count, ideally a multiple of the number of workers, to achieve more balanced data distribution during queries.</li></ul><p>For example:</p><ol><li>Consider a table named &quot;test&quot; with columns c1, c2, and c3, which are independent.</li><li>Assume there are 30 worker nodes.</li><li>The distinct count for c1 is 6.</li><li>The distinct count for c2 is 8.</li><li>The distinct count for c3 is 5.</li></ol><p>In this case, none of the individual distinct counts meets the worker node count. While the combination of c1 and c2 has a distinct count of 48 (higher than the worker count), it&#x27;s not an ideal Cluster Key since it&#x27;s not a multiple of the worker count. However, combining c1, c2, and c3 results in a distinct count that is 8 times the worker count, providing a more balanced data distribution.</p><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="selecting-the-bucket-number">Selecting the Bucket Number<a href="#selecting-the-bucket-number" class="hash-link" aria-label="Direct link to Selecting the Bucket Number" title="Direct link to Selecting the Bucket Number">​</a></h3><p>Within a partition:</p><ul><li>Each row is assigned a bucket number based on the Cluster Key value using the modulo operation (<code>% BUCKETS</code>).</li><li>Partitions with the same bucket number are sent to the same worker node for computation.</li></ul><p>Choosing an appropriate bucket number is crucial for both storage and query performance. General guidelines include:</p><ul><li>Ensure the bucket number is a multiple of the worker count to ensure balanced query distribution. It&#x27;s typically recommended to set it as 1 or 2 times the worker count (to allow for future worker expansion).</li><li>Ensure each bucket number within a partition has enough data to avoid generating excessively small partitions. For smaller tables, aim for at least 1GB of data per bucket number per partition. Avoid setting an excessively high bucket number, as it can result in having fewer bucket numbers than worker nodes.</li></ul><h3 class="anchor anchorWithHideOnScrollNavbar_l3HI" id="deciding-on-cluster-by-definition-changes">Deciding on Cluster By Definition Changes<a href="#deciding-on-cluster-by-definition-changes" class="hash-link" aria-label="Direct link to Deciding on Cluster By Definition Changes" title="Direct link to Deciding on Cluster By Definition Changes">​</a></h3><p>Over time, data changes, query patterns evolve, and the number of worker nodes may fluctuate. This might necessitate updating the Cluster Key or bucket number. However, making such changes comes with a cost and requires careful consideration:</p><ul><li>Modifying the Cluster Key necessitates reclustering existing data, which can be time-consuming depending on the data size.</li><li>During the reclustering process, queries on the existing data revert to treating the table as a regular table, temporarily losing all Bucket table benefits.</li><li>Reclustering consumes resources on the write workers, potentially impacting existing queries, merges, and other tasks. Therefore, it&#x27;s essential to assess the current workload on the Cnch cluster and determine the optimal time for making such changes.</li></ul><p>Two scenarios for modifying the Cluster By definition are:</p><ul><li>Changing the Cluster Key: This indicates that the current data arrangement no longer provides Bucket table benefits. Thus, there&#x27;s no need to consider the temporary loss of benefits during reclustering. However, it&#x27;s essential to evaluate the impact of the reclustering task on existing workloads to determine if and when it can be executed.</li><li>Changing the bucket number: In this case, the current Bucket table benefits are still valuable. Therefore, it&#x27;s crucial to coordinate with the business team to identify an acceptable performance degradation window and assess the duration of the reclustering process to determine the best time to proceed. Additionally, consider the impact of the reclustering task on existing workloads.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_HAaO padding--none margin-left--sm"><li class="tag_Ut5_"><a class="tag_sQub tagRegular_dfhI" href="/docs/0.3.0/tags/docs">Docs</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ByConity/byconity.github.io/tree/main/versioned_docs/version-0.3.0/table-design/table-engine.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_O9Og" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_DEFe"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/0.3.0/table-design/data-model"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Data Model</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/0.3.0/table-design/indexes"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Indexes</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Q7NC thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#cnchmergetree-table-engine" class="table-of-contents__link toc-highlight">CnchMergeTree Table Engine</a><ul><li><a href="#implementation-principles" class="table-of-contents__link toc-highlight">Implementation Principles</a></li><li><a href="#table-creation-statement-and-related-configurations" class="table-of-contents__link toc-highlight">Table Creation Statement and Related Configurations</a></li><li><a href="#cnchkafka-table-engine" class="table-of-contents__link toc-highlight">CnchKafka Table Engine</a></li><li><a href="#component-description" class="table-of-contents__link toc-highlight">Component Description</a></li></ul></li><li><a href="#designing-bucket-tables" class="table-of-contents__link toc-highlight">Designing Bucket Tables</a><ul><li><a href="#selecting-the-cluster-key" class="table-of-contents__link toc-highlight">Selecting the Cluster Key</a></li><li><a href="#selecting-the-bucket-number" class="table-of-contents__link toc-highlight">Selecting the Bucket Number</a></li><li><a href="#deciding-on-cluster-by-definition-changes" class="table-of-contents__link toc-highlight">Deciding on Cluster By Definition Changes</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row"><div class="col col--3"><img src="/img/footer-logo.svg" alt="ByConity" class="themedImage_DeRy themedImage--light_hbln footer__logo"><img src="/img/footer-logo.svg" alt="ByConity" class="themedImage_DeRy themedImage--dark_qgR1 footer__logo"></div><div class="col"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction/main-principle-concepts">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/community">Community</a></li><li class="footer__item"><a class="footer__link-item" href="/users">Users</a></li><li class="footer__item"><a href="https://space.bilibili.com/2065226922?spm_id_from=333.1007.0.0" target="_blank" rel="noopener noreferrer" class="footer__link-item">Bilibili<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_LBPb"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/ByConity/ByConity" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_LBPb"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 ByteDance.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.41346e7c.js"></script>
<script src="/assets/js/main.7c81538f.js"></script>
</body>
</html>